<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submission Form</title>
    <style>
      /* General styles */
      * {
        font-family: "Poppins", sans-serif;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(45deg, #064f02, #2ee88b);
        background-size: 400% 400%;
        animation: gradientBackground 10s ease infinite;
        user-select: none;
      }

      @keyframes gradientBackground {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .form-container {
        background-color: #fffbe6;
        padding: 2rem;
        border-radius: 30px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 0 0 2rem rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 400px;
        align-items: center;
        position: relative;
      }

      .camera-container {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px dashed #ccc;
        border-radius: 15px;
        width: 100%;
        height: 200px;
        overflow: hidden;
        background-color: #fafafa;
      }

      .camera-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 15px;
      }

      .form-input {
        width: 100%;
      }

      .form-input label {
        font-weight: bold;
        display: block;
        margin-bottom: 0.5rem;
      }

      .form-input textarea {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ccc;
        border-radius: 10px;
      }

      button {
        background-color: hsl(140, 78%, 16%);
        color: white;
        padding: 0.8rem;
        border: none;
        border-radius: 30px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.3s ease;
        width: 100%;
      }

      button:hover {
        transform: scale(1.05);
      }

      #map {
        width: 100%;
        height: 200px;
        border-radius: 15px;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>Submit Information</h2>

      <!-- Camera input -->
      <div class="camera-container" onclick="captureImage()">
        <img
          src="https://img.icons8.com/material-outlined/50/000000/camera--v1.png"
          alt="Camera Logo"
          id="camera-logo"
        />
        <video id="camera-stream" style="display: none" autoplay></video>
        <canvas id="camera-canvas" style="display: none"></canvas>
      </div>

      <!-- Capture location button -->
      <button type="button" onclick="captureLocation()">Capture Location</button>

      <!-- Google Map -->
      <div id="map"></div>

      <!-- Description input -->
      <div class="form-input">
        <label for="description">Description</label>
        <textarea id="description" placeholder="Enter a description..."></textarea>
      </div>

      <!-- CSRF Token -->
      {% csrf_token %}

      <!-- Submit button -->
      <button class="submit-btn" type="button" onclick="submitForm()">Submit</button>
    </div>

    <script>
      let videoStream = null;
      let userLocation = null;
      let imageBase64 = null;

      // Start camera on click
      function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then((stream) => {
              videoStream = stream;
              const cameraStream = document.getElementById("camera-stream");
              const cameraLogo = document.getElementById("camera-logo");
              cameraStream.srcObject = stream;
              cameraStream.style.display = "block";
              cameraLogo.style.display = "none";
            })
            .catch(() => {
              alert("Camera access denied.");
            });
        }
      }

      // Capture image and stop camera
      function captureImage() {
        const cameraStream = document.getElementById("camera-stream");
        const cameraCanvas = document.getElementById("camera-canvas");
        const cameraLogo = document.getElementById("camera-logo");

        if (videoStream) {
          const context = cameraCanvas.getContext("2d");
          cameraCanvas.width = cameraStream.videoWidth;
          cameraCanvas.height = cameraStream.videoHeight;
          context.drawImage(cameraStream, 0, 0, cameraCanvas.width, cameraCanvas.height);

          imageBase64 = cameraCanvas.toDataURL("image/png");
          cameraLogo.src = imageBase64;
          cameraLogo.style.display = "block";
          cameraStream.style.display = "none";

          // Stop the camera
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        } else {
          startCamera();
        }
      }

      // Capture user's current location
      function captureLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: userLocation,
              });

              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Current Location",
              });
              alert("Location captured!");
            },
            () => {
              alert("Unable to retrieve your location.");
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      // Form submission
      function submitForm() {
        const description = document.getElementById("description").value.trim();
        if (!userLocation) {
          alert("Please capture your location first.");
          return;
        }
        if (!imageBase64) {
          alert("Please capture an image.");
          return;
        }
        if (description.length < 10) {
          alert("Description must be at least 10 words.");
          return;
        }

        const data = new FormData();
        data.append("description", description);
        data.append("latitude", userLocation.lat);
        data.append("longitude", userLocation.lng);
        data.append("image", imageBase64);

        fetch("/submit-report/", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: data,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              alert(data.message);
              // Reset the form
              document.getElementById("description").value = "";
              document.getElementById("camera-logo").style.display = "block";
              document.getElementById("camera-stream").style.display = "none";
              userLocation = null;
            }
          })
          .catch((error) => {
            alert("Something went wrong!");
          });
          // Clear the form after submission
        document.getElementById("description").value = "";
        userLocation = null;
        document.getElementById("map").innerHTML = "";
        document.getElementById("camera-logo").src =
          "https://img.icons8.com/material-outlined/50/000000/camera--v1.png";
        document.getElementById("camera-logo").style.display = "block";
        document.getElementById("camera-stream").style.display =Â "none";

      }
    </script>

    <!-- Google Maps API -->
    <script
      src="MAPS_API"

      async
      defer
    ></script>
  </body>
</html>


